import { NextRequest } from 'next/server'; import { prisma } from '@/lib/db'; import Papa from 'papaparse'; import { UnitDTO } from '@/lib/validation';
export async function POST(req:NextRequest){ const form=await req.formData(); const file=form.get('file') as File | null; if(!file) return Response.json({ error:'file missing'},{ status:400 }); const text=await file.text(); const parsed=Papa.parse(text,{ header:true }); const rows=(parsed.data as any[]).filter(Boolean); const valid:any[]=[]; for(const r of rows){ try{ valid.push(UnitDTO.parse(r)); }catch{} } if(!valid.length) return Response.json({ inserted:0 },{ status:200 }); await prisma.unit.createMany({ data: valid, skipDuplicates:true }); return Response.json({ inserted: valid.length },{ status:201 }); }
